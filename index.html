<script>
    const tables = {};
    for (let i = 1; i <= 35; i++) {
        tables[`Mesa ${i}`] = [];
    }

    function populateTableOptions() {
        const tableSelect = document.getElementById('table');
        for (let i = 1; i <= 35; i++) {
            const option = document.createElement('option');
            option.value = `Mesa ${i}`;
            option.textContent = `Mesa ${i}`;
            tableSelect.appendChild(option);
        }
    }

    function updateGuestList() {
        const tableSelect = document.getElementById('table');
        const guestList = document.getElementById('guestList');
        const selectedTable = tableSelect.value;

        if (selectedTable) {
            guestList.style.display = 'block';
            guestList.innerHTML = `<h3>Invitados en ${selectedTable}:</h3>`;
            if (tables[selectedTable].length === 0) {
                guestList.innerHTML += '<p>No hay invitados aún.</p>';
            } else {
                const ul = document.createElement('ul');
                tables[selectedTable].forEach(guest => {
                    const li = document.createElement('li');
                    li.textContent = guest;
                    ul.appendChild(li);
                });
                guestList.appendChild(ul);
            }
            drawTable(selectedTable);
        } else {
            guestList.style.display = 'none';
            clearTable();
        }
    }

    function drawTable(table) {
        const svg = document.getElementById('tableSvg');
        svg.innerHTML = '';

        const centerX = svg.clientWidth / 2;
        const centerY = svg.clientHeight / 2;
        const radius = 80;
        const seatRadius = 10;
        const seats = 10;
        const angleStep = (2 * Math.PI) / seats;

        const tableCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        tableCircle.setAttribute('cx', centerX);
        tableCircle.setAttribute('cy', centerY);
        tableCircle.setAttribute('r', radius / 2);
        tableCircle.setAttribute('fill', '#00796b');
        svg.appendChild(tableCircle);

        for (let i = 0; i < seats; i++) {
            const angle = i * angleStep;
            const x = centerX + radius * Math.cos(angle);
            const y = centerY + radius * Math.sin(angle);

            const seat = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            seat.setAttribute('cx', x);
            seat.setAttribute('cy', y);
            seat.setAttribute('r', seatRadius);
            seat.setAttribute('class', 'seat');

            if (tables[table][i]) {
                seat.classList.add('occupied');
            }

            svg.appendChild(seat);
        }
    }

    function clearTable() {
        const svg = document.getElementById('tableSvg');
        svg.innerHTML = '';
    }

    async function sendDataToServer(data) {
        try {
            const response = await fetch('https://script.google.com/macros/s/AKfycbyBnFO8gl44nZKRyJTqy3cm_XrevWjfc2q1hkpbGTUHsjQ-vsOQNmM784I3Yef4muaA/exec', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });
            if (response.ok) {
                alert('Datos enviados exitosamente.');
            } else {
                const errorText = await response.text();
                console.error('Error:', errorText);
                alert('Hubo un problema al enviar los datos.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Hubo un problema al enviar los datos.');
        }
    }

    function goToNextScreen(currentScreen) {
        const screen0 = document.getElementById('screen0');
        const screen1 = document.getElementById('screen1');
        const screen2 = document.getElementById('screen2');
        const screen3 = document.getElementById('screen3');

        if (currentScreen === 1) {
            const accompany = document.getElementById('accompany').value;
            if (accompany === 'accompanied') {
                const numAccompanists = parseInt(document.getElementById('numAccompanists').value, 10);
                const container = document.getElementById('accompanistsDetailsContainer');
                container.innerHTML = '';
                for (let i = 1; i <= numAccompanists; i++) {
                    const html = `
                        <h3>Acompañante ${i}</h3>
                        <label for="accompFirstName${i}">Nombre:</label>
                        <input type="text" id="accompFirstName${i}" name="accompFirstName${i}" required>
                        <label for="accompMenu${i}">Elegir Menú:</label>
                        <select id="accompMenu${i}" name="accompMenu${i}" required>
                            <option value="">Selecciona tu menú</option>
                            <option value="Normal">Normal</option>
                            <option value="Celiaco">Celíaco</option>
                            <option value="Vegetariano">Vegetariano</option>
                            <option value="Vegano">Vegano</option>
                        </select>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                }
                screen1.classList.add('hidden');
                screen2.classList.remove('hidden');
            } else {
                screen1.classList.add('hidden');
                screen3.classList.remove('hidden');
            }
        } else if (currentScreen === 2) {
            screen2.classList.add('hidden');
            screen3.classList.remove('hidden');
        }else if(currentScreen===0){
            screen0.classList.add('hidden');
            screen1.classList.remove('hidden');
        }
    }

    function goToPreviousScreen(currentScreen) {
        const screen0 = document.getElementById('screen0');
        const screen1 = document.getElementById('screen1');
        const screen2 = document.getElementById('screen2');
        const screen3 = document.getElementById('screen3');

        if (currentScreen === 2) {
            screen2.classList.add('hidden');
            screen1.classList.remove('hidden');
        } else if (currentScreen === 3) {
            const accompany = document.getElementById('accompany').value;
            if (accompany === 'accompanied') {
                screen3.classList.add('hidden');
                screen2.classList.remove('hidden');
            } else {
                screen3.classList.add('hidden');
                screen1.classList.remove('hidden');
            }
        }
    }

    document.getElementById('accompany').addEventListener('change', function () {
        const accompaniedDetails = document.getElementById('accompaniedDetails');
        if (this.value === 'accompanied') {
            accompaniedDetails.style.display = 'block';
            document.getElementById('numAccompanists').required = true;
        } else {
            accompaniedDetails.style.display = 'none';
            document.getElementById('numAccompanists').required = false;
        }
    });

    document.getElementById('fiestaForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const grade = document.getElementById('grade').value;
        const escalafon = document.getElementById('escalafon').value;
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const id = document.getElementById('id').value;
        const accompany = document.getElementById('accompany').value;
        const numAccompanists = accompany === 'accompanied' ? parseInt(document.getElementById('numAccompanists').value, 10) : 0;
        const table = document.getElementById('table').value;
        const menu = document.getElementById('menu').value;

        const totalSeats = numAccompanists + 1;

        const accompDetails = [];
        for (let i = 1; i <= numAccompanists; i++) {
            const accompFirstName = document.getElementById(`accompFirstName${i}`).value;
            const accompMenu = document.getElementById(`accompMenu${i}`).value;
            accompDetails.push({ name: accompFirstName, menu: accompMenu });
        }

        if (tables[table].length + totalSeats <= 10) {
            tables[table].push(`${firstName} ${lastName}`);
            accompDetails.forEach(accomp => {
                tables[table].push(accomp.name);
            });
            sendDataToServer({ grade, escalafon, firstName, lastName, id, accompany, numAccompanists, table, menu, accompDetails });
            updateGuestList();
        } else {
            alert('Esta mesa ya está llena. Por favor, elige otra mesa.');
        }
    });

    document.getElementById('table').addEventListener('change', updateGuestList);

    populateTableOptions();
</script>
